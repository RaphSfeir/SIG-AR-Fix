<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=CP850" http-equiv="Content-Type" />

  <title>File: constraint_validations.rb [sequel-3.41.0 Documentation]</title>

  <link type="text/css" media="screen" href="../../../rdoc.css" rel="stylesheet" />

  <script src="../../../js/jquery.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../../js/thickbox-compressed.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../../js/quicksearch.js" type="text/javascript"
    charset="utf-8"></script>
  <script src="../../../js/darkfish.js" type="text/javascript"
    charset="utf-8"></script>
</head>

<body class="file file-popup">
  <div id="metadata">
    <dl>
      <dt class="modified-date">Last Modified</dt>
      <dd class="modified-date">2012-11-14 23:59:15 +0100</dd>

      
      <dt class="requires">Requires</dt>
      <dd class="requires">
        <ul>
        
        </ul>
      </dd>
      

      
    </dl>
  </div>

  <div id="documentation">
    
    <div class="description">
      <h2>Description</h2>
      
<p>The constraint_validations extension is designed to easily create database
constraints inside create_table and alter_table blocks.  It also adds
relevant metadata about the constraints to a separate table, which the
constraint_validations model plugin uses to setup automatic validations.</p>

<p>To use this extension, you first need to load it into the database:</p>

<pre>DB.extension(:constraint_validations)</pre>

<p>Note that you should only need to do this when modifying the constraint
validations (i.e. when migrating).  You should probably not load this
extension in general application code.</p>

<p>You also need to make sure to add the metadata table for the automatic
validations.  By default, this table is called
sequel_constraint_validations.</p>

<pre>DB.create_constraint_validations_table</pre>

<p>This table should only be created once.  For new applications, you
generally want to create it first, before creating any other application
tables.</p>

<p>Because migrations instance_eval the up and down blocks on a database,
using this extension in a migration can be done via:</p>

<pre>Sequel.migration do
  up do
    extension(:constraint_validations)
    # ...
  end
  down do
    extension(:constraint_validations)
    # ...
  end
end</pre>

<p>However, note that you cannot use change migrations with this extension,
you need to use separate up/down migrations.</p>

<p>The API for creating the constraints with automatic validations is similar
to the validation_helpers model plugin API.  However, instead of having
separate validates_* methods, it just adds a validate method that accepts a
block to the schema generators.  Like the create_table and alter_table
blocks, this block is instance_evaled and offers its own DSL. Example:</p>

<pre>DB.create_table(:table) do
  Integer :id
  String :name

  validate do
    presence :id
    min_length 5, :name
  end
end</pre>

<p>instance_eval is used in this case because create_table and alter_table
already use instance_eval, so losing access to the surrounding receiver is
not an issue.</p>

<p>Here's a breakdown of the constraints created for each constraint
validation method:</p>
<table class="rdoc-list"><tr><td class="rdoc-term"><p>All constraints except unique unless :allow_nil is true </p></td>
<td>
<p>CHECK column IS NOT NULL</p>
</td></tr><tr><td class="rdoc-term"><p>presence (<a href="../../../String.html">String</a> column) </p></td>
<td>
<p>CHECK trim(column) != "</p>
</td></tr><tr><td class="rdoc-term"><p>exact_length 5 </p></td>
<td>
<p>CHECK char_length(column) = 5</p>
</td></tr><tr><td class="rdoc-term"><p>min_length 5 </p></td>
<td>
<p>CHECK char_length(column) &gt;= 5</p>
</td></tr><tr><td class="rdoc-term"><p>max_length 5 </p></td>
<td>
<p>CHECK char_length(column) &lt;= 5</p>
</td></tr><tr><td class="rdoc-term"><p>length_range 3..5 </p></td>
<td>
<p>CHECK char_length(column) &gt;= 3 AND char_length(column) &lt;= 5</p>
</td></tr><tr><td class="rdoc-term"><p>length_range 3...5 </p></td>
<td>
<p>CHECK char_length(column) &gt;= 3 AND char_length(column) &lt; 5</p>
</td></tr><tr><td class="rdoc-term"><p>format /foo\d+/ </p></td>
<td>
<p>CHECK column ~ 'foo\d+'</p>
</td></tr><tr><td class="rdoc-term"><p>format /foo\d+/i </p></td>
<td>
<p>CHECK column ~* 'foo\d+'</p>
</td></tr><tr><td class="rdoc-term"><p>like 'foo%' </p></td>
<td>
<p>CHECK column LIKE 'foo%'</p>
</td></tr><tr><td class="rdoc-term"><p>ilike 'foo%' </p></td>
<td>
<p>CHECK column ILIKE 'foo%'</p>
</td></tr><tr><td class="rdoc-term"><p>includes ['a', 'b'] </p></td>
<td>
<p>CHECK column IN ('a', 'b')</p>
</td></tr><tr><td class="rdoc-term"><p>includes [1, 2] </p></td>
<td>
<p>CHECK column IN (1, 2)</p>
</td></tr><tr><td class="rdoc-term"><p>includes 3..5 </p></td>
<td>
<p>CHECK column &gt;= 3 AND column &lt;= 5</p>
</td></tr><tr><td class="rdoc-term"><p>includes 3...5 </p></td>
<td>
<p>CHECK column &gt;= 3 AND column &lt; 5</p>
</td></tr><tr><td class="rdoc-term"><p>unique </p></td>
<td>
<p>UNIQUE (column)</p>
</td></tr></table>

<p>There are some additional API differences:</p>
<ul><li>
<p>Only the :message and :allow_nil options are respected.  The :allow_blank
and :allow_missing options are not respected.</p>
</li><li>
<p>A new option, :name, is respected, for providing the name of the
constraint.  It is highly recommended that you provide a name for all
constraint validations, as otherwise, it is difficult to drop the
constraints later.</p>
</li><li>
<p>The includes validation only supports an array of strings, and array of
integers, and a range of integers.</p>
</li><li>
<p>There are like and ilike validations, which are similar to the format
validation but use a case sensitive or case insensitive LIKE pattern. LIKE
patters are very simple, so many regexp patterns cannot be expressed by
them, but only a couple databases (PostgreSQL and MySQL) support regexp
patterns.</p>
</li><li>
<p>When using the unique validation, column names cannot have embedded commas.
For similar reasons, when using an includes validation with an array of
strings, none of the strings in the array can have embedded commas.</p>
</li><li>
<p>The unique validation does not support an arbitrary number of columns. For
a single column, just the symbol should be used, and for an array of
columns, an array of symbols should be used.  There is no support for
creating two separate unique validations for separate columns in a single
call.</p>
</li><li>
<p>A drop method can be called with a constraint name in a alter_table
validate block to drop an existing constraint and the related validation
metadata.</p>
</li><li>
<p>While it is allowed to create a presence constraint with :allow_nil set to
true, doing so does not create a constraint unless the column has <a
href="../../../String.html">String</a> type.</p>
</li></ul>

<p>Note that this extension has the following issues on certain databases:</p>
<ul><li>
<p>MySQL does not support check constraints (they are parsed but ignored), so
using this extension does not actually set up constraints on MySQL, except
for the unique constraint.  It can still be used on MySQL to add the
validation metadata so that the plugin can setup automatic validations.</p>
</li><li>
<p>On SQLite, adding constraints to a table is not supported, so it must be
emulated by dropping the table and recreating it with the constraints. If
you want to use this plugin on SQLite with an alter_table block, you should
drop all constraint validation metadata using
<tt>drop_constraint_validations_for(:table=&gt;'table')</tt>, and then
readd all constraints you want to use inside the alter table block, making
no other changes inside the alter_table block.</p>
</li></ul>

    </div>
    
  </div>
</body>
</html>

